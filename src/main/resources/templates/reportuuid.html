<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <meta name="description" content="">
        <meta name="author" content="">
        <title>VIEWUUID</title>

        <link rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <script
            src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="/js/FileSaver.min.js"></script>


    </head>
    <body>
        <div class="container" id="app">

        
        
            <a :href="updateUrl" class="btn btn-warning active float-right"
                role="button" aria-pressed="true">寫入口袋名单</a>
            
            <hr>
            <div>

                <table class="table" v-if="Object.values(pending) != 0">
                    <tr>
                        <td style="width: 10%">
                            {{pending.name}}
                        </td>

                        <td>
                            <ul class="list-inline">
                                <li class="list-inline-item" v-for="contest in
                                    pending.contestids">
                                    ({{contest.contestid}}){{contest.members}}
                                </li>

                            </ul>


                        </td>
                        <td>
                            
                            <button v-if="checkedIn !=''"
                            @click="addLocation"
                            class="btn
                            btn-primary active" role="button"
                            aria-pressed="true">移入</button>
                        </td>

                    </tr>
                    <tr>

                        <td style="width: 10%">
                            --还可排入
                        </td>

                        <td style="width: 80%">
                            <ul class="list-inline">
                                <li class="list-group-item" v-for="location in
                                    locations.capable">

                                    <input type="radio"
                                    v-bind:value="location.schoolid"
                                    v-model="checkedIn">

                                    {{location.name}}
                                    <ul class="list-inline">
                                        <li class="list-inline-item"
                                            v-for="contest in
                                            location.contestids">
                                            ({{contest.contestid}}){{contest.members}}
                                        </li>

                                    </ul>
                                </li>
                            </ul>
                        </td>

                    </tr>

                    <tr>

                        <td style="width: 10%">
                            --无法排入
                        </td>

                        <td style="width: 80%">
                            <ul class="list-inline">
                                <li class="list-group-item" v-for="location in
                                    locations.notcapable">

                                    <input type="radio"
                                    v-bind:value="location.schoolid"
                                    v-model="checkedIn">

                                    {{location.name}}
                                    <ul class="list-inline">
                                        <li class="list-inline-item"
                                            v-for="contest in
                                            location.contestids">
                                           
                                            ({{contest.contestid}}){{contest.members}}
                                        </li>

                                    </ul>
                                </li>
                            </ul>

                        </td>
                    </tr>
                </table>
            </div>


            <div>

                <table class="table">
                    <thead>
                        <!--<td>代码</td>-->
                        <td>場地</td>
                        <td>電腦数</td>
                        <td>參賽隊-人數-距離</td>
                        <td>
                            <button v-if="checkedOut !=''"
                                @click="addPending"
                                class="btn
                                btn-primary active" role="button"
                                aria-pressed="true">移出</button>

                            <!--<button @click="downloadReport" class="btn-->
                            <!--btn-primary active" role="button"-->
                            <!--aria-pressed="true">下载</button>-->



                    </td>
                </thead>
                <tbody>
                    <tr v-for="item in items">

                        <td>
                            {{item.location.name}}
                        </td>
                        <td>
                            <ul class="list-group">
                                <li class="list-group-item" v-for="contest in
                                    item.location.contestids">
                                    ({{contest.contestid}}){{contest.members}}
                                </li>
                            </ul>

                        </td>
                        <td>
                            <ul class="list-group">
                                <li class="list-group-item" v-for="team in
                                    item.teams">
                                    <input type="radio"
                                        v-bind:value="team.schoolid"
                                        v-model="checkedOut">
                                    {{team.name}}({{team.members}})&nbsp;&nbsp;距离:{{team.distance.toFixed(2)}}公尺
                                    <table>
                                        <tr>
                                            <td v-for="contest in
                                                team.contestids">
                                                ({{contest.contestid}}){{contest.members}}
                                            </td>
                                        </tr>
                                    </table>
                      
                                </li>
                            </ul>
                        </td>



                    </tr>
                </tbody>
            </table>

        </div>


        <footer>
            <script th:inline="javascript">
        /*<![CDATA[*/
        Vue.prototype.$http = axios;
        let config = {
            headers: {
                'content-type': 'application/json;CHARSET=UTF-8'
            }
        };

        var app = new Vue({
            el: '#app',
            data: {
                uuid: /*[[${uuid}]]*/ 'default',
                contestid: "",
                items: [],
                pending: {},
                checkedOut:'',
                checkedIn:'',
                locations: [],
                updateUrl: ""
            },
            created: function() {
                let vm = this;
                let url =  "/api/report/uuid/" + this.uuid;
                

                this.$http.get(url, config).then((response) => {

                    vm.items = JSON.parse(response.data.report);
                    // JSON.parse(response.data.report).forEach(function(item){
                    //     if(item.location.schoolid === "999999"){
                    //         vm.pending.push(item.location)
                    //     } else {
                           
                    //         vm.items.push(item);
                    //     }
                    // })



                vm.updateUrl = "/report/" + vm.contestid + "/lock/" + vm.uuid;

          

                }, (response) => {
                    // error callback
                });


            },
            methods: {
                addLocation: function(){
                    let vm = this;
                    this.items.forEach(function(item){
                        if(vm.checkedIn === item.location.schoolid){
                        console.log(vm.pending.schoolid + "加入" + item.location.schoolid);  

                        }
                    })




                },
                addPending: function() {

                    let vm = this;

                    if(Object.values(vm.pending).length === 0){
                        let teamcontestid1 = 0;
                        let teamcontestid2 = 0;
                        let teamcontestid3 = 0;
                        let teamcontestid4 = 0;
                        
                        this.items.forEach(function(item){
                      
                            let tmpTeams = [];
                            item.teams.forEach((team) => {
                       
                                //移除选取的
                                if(vm.checkedOut === team.schoolid){
                       
                                    //取出参赛队伍人数
                                    team.contestids.forEach(function(contest){
                                        if(contest.contestid === 1){
                                            teamcontestid1 = contest.members
                                        }
                                        if(contest.contestid === 2){
                                            teamcontestid2 = contest.members
                                        }
                                        if(contest.contestid === 3){
                                            teamcontestid3 = contest.members
                                        }
                                        if(contest.contestid === 4){
                                            teamcontestid4 = contest.members
                                        }
                                    })

                                
                                    // console.log(location.location.name);
                                    item.location.contestids.forEach(function(contest){
                                        //contestid:1
                                        if(contest.contestid === 1){
                                            contest.members = contest.members + teamcontestid1
                                        }
                                        //contestid:2
                                        if(contest.contestid === 2){
                                            contest.members = contest.members + teamcontestid2
                                        }
                                        //contestid:3
                                        if(contest.contestid === 3){
                                            contest.members = contest.members + teamcontestid3
                                        }

                                        //contestid:4
                                        if(contest.contestid === 4){
                                            contest.members = contest.members + teamcontestid4
                                        }
                                    })
                                    vm.pending = team;
                                    vm.checkedOut = '';

                                } else {
                                    tmpTeams.push(team);
                                }
                             })

                            item.teams = tmpTeams;

                         })

                        // //重新计算可排入场地
                        vm.locations.capable = [];
                        vm.locations.notcapable = [];
                        
                        let notcapable = [];
                        this.items.forEach((item) => {
                            let locationcontestid1 = 0;
                            let locationcontestid2 = 0;
                            let locationcontestid3 = 0;
                            let locationcontestid4 = 0;
                            
                            item.location.contestids.forEach(function(contest){
                                // console.log(item.location.name);

                                if(contest.contestid === 1){
                                    locationcontestid1 = contest.members;
                                }

                                if(contest.contestid === 2){
                                    locationcontestid2 = contest.members;
                                }


                                if(contest.contestid === 3){
                                    locationcontestid3 = contest.members;
                                }

                                if(contest.contestid === 4){
                                    locationcontestid4 = contest.members;
                                }

                            })

                            // console.log(item.location.name+"1:"+locationcontestid1+",2:"+locationcontestid2+",3:"+locationcontestid3);
                        
                            if(locationcontestid1>=teamcontestid1 && locationcontestid2>=teamcontestid2 && locationcontestid3>=teamcontestid3 && locationcontestid4>=teamcontestid4){
                                // console.log(item.location.name);
                                // capable.push(item.location);
                                vm.locations.capable.push(item.location);
                            } else {
                                // notcapable.push(item.location);
                                vm.locations.notcapable.push(item.location);

                            }

                        })
                    




                    } else {
                        console.log("pending里有学校,无法再加入");
                    }
                    
                  

                },
                downloadReport: function(){
                    // /api/report/download/{uuid}
                    //
                    let config = {
                        headers: {
                            'content-type': 'application/json;CHARSET=UTF-8'
                        },
                        responseType: 'arraybuffer'
                    };

                    let url = "/api/report/download/"+ this.uuid;
                    let vm = this;
                    this.$http.get(url, config)
                        .then((response) => {
                            var blob = new Blob([response.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                            saveAs(blob, vm.contestid + '.xlsx');
                        });




                }
            }
        })

         /*]]>*/
        </script>
        </footer>


    </body>
</html>