<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <meta name="description" content="">
        <meta name="author" content="">
        <title>VIEWUUID</title>

        <link rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <script
            src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script src="/js/FileSaver.min.js"></script>


    </head>
    <body>
        <div class="container" id="app">

            <div> 未排入学校

                <!-- {{checked}} -->
                <table class="table">
                    <tr>
                        <td>
                            {{pending.name}}
                        </td>
                        <td v-for="contest in pending.contestids">
                            ({{contest.contestid}}){{contest.members}}
                        </td>
                    </tr>
                    <tr>
                        <td>

                        </td>
                        <td>

                        </td>
                    </tr>
                </table>
            </div>


            <div>
                <!--<p> 場次:{{contestid}} </p>-->
                <table class="table">
                    <thead>
                        <!--<td>代码</td>-->
                        <td>場地</td>
                        <td>電腦数</td>
                        <td>參賽隊-人數-距離</td>
                        <td>

                            <button v-if="checked !=''"
                                @click="addPending"
                                class="btn
                                btn-primary active" role="button"
                                aria-pressed="true">移出</button>


                            <!--<button @click="downloadReport" class="btn-->
                            <!--btn-primary active" role="button"-->
                            <!--aria-pressed="true">下载</button>-->

                        <a :href="updateUrl" class="btn btn-warning active"
                            role="button" aria-pressed="true">確定寫入</a>

                    </td>
                </thead>
                <tbody>
                    <tr v-for="item in items">
                        <!--<td>{{item.location.schoolid}}-->
                        <!--</td>-->
                        <td>

                            {{item.location.name}}
                        </td>
                        <td>
                            <ul class="list-group">
                                <li class="list-group-item" v-for="contest in
                                    item.location.contestids">
                                    ({{contest.contestid}}){{contest.members}}
                                </li>
                            </ul>

                        </td>
                        <td>
                            <ul class="list-group">
                                <li class="list-group-item" v-for="team in
                                    item.teams">
                                    <input type="radio"
                                        v-bind:value="team.schoolid"
                                        v-model="checked">
                                    {{team.name}}({{team.members}})&nbsp;&nbsp;距离:{{team.distance.toFixed(2)}}公尺
                                    <table>

                                        <tr>
                                            <td v-for="contest in
                                                team.contestids">
                                                ({{contest.contestid}}){{contest.members}}
                                            </td>
                                        </tr>
                                    </table>
                                    <!--<ul class="list-group">-->
                                    <!--<li v-for="contest in team.contestids">-->
                                    <!--{{contest.contestid}}:{{contest.members}}-->
                                    <!--</li>-->

                                    <!--</ul>-->
                                    <!--<p v-if="(team.ticket.length==6) && (item.location.schoolid != team.ticket)" class="text-danger">-->
                                    <!---->
                                    <!--(  {{team.ticket}}){{team.name}}({{team.members}}) - -->
                                    <!--{{parseInt(team.distance)}} -->
                                    <!---->
                                    <!--</p>-->
                                    <!--<p v-else class="text-info">-->
                                    <!---->
                                    <!--{{team.name}}({{team.members}}) - -->
                                    <!--{{parseInt(team.distance)}}-->
                                    <!---->
                                    <!--</p>-->
                                </li>
                            </ul>
                        </td>


                    </tr>
                </tbody>
            </table>

        </div>


        <footer>
            <script th:inline="javascript">
        /*<![CDATA[*/
        Vue.prototype.$http = axios;
        let config = {
            headers: {
                'content-type': 'application/json;CHARSET=UTF-8'
            }
        };

        var app = new Vue({
            el: '#app',
            data: {
                uuid: /*[[${uuid}]]*/ 'default',
                contestid: "",
                items: [],
                pending: {},
                checked:'',
                capableList: [],
                updateUrl: ""
            },
            created: function() {
                let vm = this;
                let url =  "/api/report/uuid/" + this.uuid;
                

                this.$http.get(url, config).then((response) => {

                    vm.items = JSON.parse(response.data.report);
                    // JSON.parse(response.data.report).forEach(function(item){
                    //     if(item.location.schoolid === "999999"){
                    //         vm.pending.push(item.location)
                    //     } else {
                           
                    //         vm.items.push(item);
                    //     }
                    // })



                vm.updateUrl = "/report/" + vm.contestid + "/lock/" + vm.uuid;

          

                }, (response) => {
                    // error callback
                });


            },
            methods: {
                addPending: function() {

                    let vm = this;
                    let teamcontestid1 = 0;
                    let teamcontestid2 = 0;
                    let teamcontestid3 = 0;
                    let teamcontestid4 = 0;
                        
                    this.items.forEach(function(item){
                      
                       let tmpTeams = [];
                       item.teams.forEach((team) => {
                       
                            //移除选取的
                            if(vm.checked === team.schoolid){
                       
                                //取出参赛队伍人数
                                team.contestids.forEach(function(contest){
                                    if(contest.contestid === 1){
                                        teamcontestid1 = contest.members
                                    }
                                    if(contest.contestid === 2){
                                        teamcontestid2 = contest.members
                                    }
                                    if(contest.contestid === 3){
                                        teamcontestid3 = contest.members
                                    }
                                    if(contest.contestid === 4){
                                        teamcontestid4 = contest.members
                                    }
                                })

                                
                                // console.log(location.location.name);
                                item.location.contestids.forEach(function(contest){
                                    //contestid:1
                                    if(contest.contestid === 1){
                                        // console.log(contest.members)
                                        contest.members = contest.members + teamcontestid1
                                    }
                                    //contestid:2
                                    if(contest.contestid === 2){
                                        // console.log(contest.members)
                                        contest.members = contest.members + teamcontestid2
                                    }
                                    //contestid:3
                                    if(contest.contestid === 3){
                                        // console.log(contest.members)
                                        contest.members = contest.members + teamcontestid3
                                    }

                                    //contestid:4
                                    if(contest.contestid === 4){
                                        // console.log(contest.members)
                                        contest.members = contest.members + teamcontestid4
                                    }
                                })
                                vm.pending = team;
                                vm.checked = '';

                            } else {
                                tmpTeams.push(team);
                            }
                       })
                       item.teams = tmpTeams;

                    })

                    // //重新计算可排入场地
                    this.items.forEach((item) => {
                        let locationcontestid1 = 0;
                        let locationcontestid2 = 0;
                        let locationcontestid3 = 0;
                        let locationcontestid4 = 0;
                        
                        item.location.contestids.forEach(function(contest){
                            // console.log(item.location.name);

                            if(contest.contestid === 1){
                                locationcontestid1 = contest.members;
                            }

                            if(contest.contestid === 2){
                                locationcontestid2 = contest.members;
                            }


                            if(contest.contestid === 3){
                                locationcontestid3 = contest.members;
                            }

                            if(contest.contestid === 4){
                                locationcontestid4 = contest.members;
                            }

                        })

                        // console.log(item.location.name+"1:"+locationcontestid1+",2:"+locationcontestid2+",3:"+locationcontestid3);
                      
                        if(locationcontestid1>=teamcontestid1 && locationcontestid2>=teamcontestid2 && locationcontestid3>=teamcontestid3 && locationcontestid4>=teamcontestid4){
                            console.log(item.location.name);
                        }

                    })



                },
                downloadReport: function(){
                    // /api/report/download/{uuid}
                    //
                    let config = {
                        headers: {
                            'content-type': 'application/json;CHARSET=UTF-8'
                        },
                        responseType: 'arraybuffer'
                    };

                    let url = "/api/report/download/"+ this.uuid;
                    let vm = this;
                    this.$http.get(url, config)
                        .then((response) => {
                            var blob = new Blob([response.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                            saveAs(blob, vm.contestid + '.xlsx');
                        });




                }
            }
        })

         /*]]>*/
        </script>
        </footer>


    </body>
</html>